- name: Enable peers-git remotes in fastd
  notify: Restart mesh_fastd
  blockinfile:
    dest: /etc/fastd/mesh_fastd_{{ domain.id }}/remotes.conf
    marker: "# {mark} PEERS GIT (ANSIBLE)"
    content: |
      {% if mesh_fastd_deny_connections_over_mbit_integer is defined %}
      on verify "/etc/fastd/mesh_fastd/on_verify.sh";
      {% endif %}
      peer group "peers-grp" {
        {% if mesh_fastd_peer_limit is defined %}
        peer limit {{ mesh_fastd_peer_limit }};
        {% endif %}
        {% if mesh_fastd_deny_connections_over_mbit_integer is not defined %}
        include peers from "peers";
        {% endif %}
      }

- name: Generate peers symlink
  file:
    src: "/etc/fastd/mesh_fastd/peers"
    dest: "/etc/fastd/mesh_fastd_{{ domain.id }}/peers"
    state: link
