server {
        listen 80{% if item.default_site is defined and item.default_site %} default_server{% endif %};
        listen [::]:80{% if item.default_site is defined and item.default_site %} default_server{% endif %};

{% if item.tls is defined and item.tls == true %}
        listen 443 ssl{% if item.default_site is defined and item.default_site %} default_server{% endif %};
        listen [::]:443 ssl{% if item.default_site is defined and item.default_site %} default_server{% endif %};
        # TODO certs
{% endif %}

{% if item.root is defined %}
        root {{item.root}};
{% endif %}

        index index.php index.html index.htm index.nginx-debian.html;

        server_name {{ item.domain }};

{% if item.locations is defined %}
{% for location in item.locations %}
        location {{ location.location }} {
		charset utf-8;
{% if location.type == 'proxy' %}
                proxy_pass {{ location.proxy_forward_url }};
                proxy_set_header HOST $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;

{% endif %}

{% if location.directory_index | default(False) %}
                autoindex on;
{% endif %}
        }

{% endfor %}
{% endif %}


        location ~ \.php$ {
                fastcgi_pass unix:/run/php5-fpm.sock;
                fastcgi_index index.php;
                include fastcgi.conf;
        }
}
